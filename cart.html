<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Carrito - Tienda y Hogar</title>
  <link rel="stylesheet" href="styles.css" />
  <script defer src="cart.js"></script>
</head>
<body>
  <header>
    <h1>Tienda y Hogar</h1>
    <nav>
      <ul>
        <li><a href="index.html">Inicio</a></li>
        <li><a href="index.html#sobre-Nosotros">Sobre Nosotros</a></li>
        <li><a href="index.html#productos">Productos</a></li>
        <li><a href="index.html#ofertas">Ofertas</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <h2>Carrito de Compras</h2>
    <div id="carrito-items"></div>
    <div id="carrito-total"></div>
    <button id="seguir-comprando">Seguir Comprando</button>
    <button id="pedir-whatsapp" disabled>Procesar Pedido</button>
  </main>

  <!-- Modal de Pedido -->
  <div id="modal-pedido" class="modal" style="display: none;">
    <div class="modal-contenido">
      <span class="cerrar-modal">&times;</span>
      <h2>Procesar Pedido</h2>
      <form id="formulario-pedido">
        <label for="nombre">Tu nombre:</label>
        <input type="text" id="nombre" name="nombre" required />
        <label for="telefono">Tu número de WhatsApp:</label>
        <input type="tel" id="telefono" name="telefono" required />
        <label for="direccion">Dirección:</label>
        <textarea id="direccion" name="direccion" required></textarea>
        <label for="beneficiario">¿Para otra persona? (nombre y teléfono)</label>
        <textarea id="beneficiario" name="beneficiario"></textarea>
        <button type="submit">Enviar Pedido por WhatsApp</button>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const carrito = {
        productos: JSON.parse(localStorage.getItem("carrito")) || [],

        mostrarCarrito() {
          const contenedor = document.getElementById("carrito-items");
          const total = document.getElementById("carrito-total");
          contenedor.innerHTML = "";
          let totalCup = 0;

          if (this.productos.length === 0) {
            contenedor.innerHTML = "<p>Tu carrito está vacío.</p>";
            total.innerHTML = "";
            document.getElementById("pedir-whatsapp").disabled = true;
            return;
          }

          document.getElementById("pedir-whatsapp").disabled = false;

          this.productos.forEach((p) => {
            const precioCup = p.descuento ? p.descuento : p.precio;
            const subtotal = precioCup * p.cantidad;
            totalCup += subtotal;

            contenedor.innerHTML += `
              <div class="carrito-item">
                <span>${p.nombre}</span>
                <span>${precioCup} CUP x ${p.cantidad}</span>
                <span>Total: ${subtotal} CUP</span>
                <button class="btn-cantidad" data-id="${p.id}" data-action="decrease">-</button>
                <button class="btn-cantidad" data-id="${p.id}" data-action="increase">+</button>
                <button class="eliminar-item" data-id="${p.id}">Eliminar</button>
              </div>
            `;
          });

          const tasa = parseFloat(localStorage.getItem("tasa")) || 240;
          const totalUsd = (totalCup / tasa).toFixed(2);

          total.innerHTML = `
            <p>Total: ${totalCup} CUP (${totalUsd} USD al cambio de ${tasa})</p>
          `;
        },

        cambiarCantidad(id, cantidad) {
          const producto = this.productos.find((p) => p.id === id);
          if (!producto) return;
          producto.cantidad += cantidad;
          if (producto.cantidad <= 0) {
            this.productos = this.productos.filter((p) => p.id !== id);
          }
          this.guardar();
          this.mostrarCarrito();
        },

        eliminarProducto(id) {
          this.productos = this.productos.filter((p) => p.id !== id);
          this.guardar();
          this.mostrarCarrito();
        },

        guardar() {
          localStorage.setItem("carrito", JSON.stringify(this.productos));
        },

        procesarPedido() {
          const nombre = document.getElementById("nombre").value.trim();
          const telefono = document.getElementById("telefono").value.trim();
          const direccion = document.getElementById("direccion").value.trim();
          const beneficiario = document.getElementById("beneficiario").value.trim();
          const vendedor = localStorage.getItem("vendedor");

          if (!nombre || !telefono || !direccion) {
            alert("Por favor, completa todos los campos obligatorios.");
            return;
          }

          const tasa = parseFloat(localStorage.getItem("tasa")) || 240;
          let mensaje = `¡Hola! Quiero hacer un pedido desde Tienda y Hogar:%0A`;
          let totalCup = 0;

          this.productos.forEach((p) => {
            const precio = p.descuento ? p.descuento : p.precio;
            const subtotal = precio * p.cantidad;
            totalCup += subtotal;
            mensaje += `- ${p.nombre} x ${p.cantidad} = ${subtotal} CUP%0A`;
          });

          const totalUsd = (totalCup / tasa).toFixed(2);
          mensaje += `%0ATotal: ${totalCup} CUP (${totalUsd} USD al cambio de ${tasa})%0A`;
          mensaje += `%0ADatos del cliente:%0A${nombre}, ${telefono}%0ADirección: ${direccion}%0A`;
          if (beneficiario) {
            mensaje += `%0APara: ${beneficiario}`;
          }

          const numero = vendedor || "5350000000";
          const url = `https://wa.me/${numero}?text=${mensaje}`;

          window.open(url, "_blank");
        },

        setupEventListeners() {
          document.addEventListener("click", (e) => {
            const target = e.target;

            if (target.matches(".btn-cantidad")) {
              const id = target.dataset.id;
              const action = target.dataset.action;
              this.cambiarCantidad(id, action === "increase" ? 1 : -1);
            }

            if (target.matches(".eliminar-item") || target.closest(".eliminar-item")) {
              const btn = target.closest(".eliminar-item");
              const id = btn.dataset.id;
              this.eliminarProducto(id);
            }

            if (target.id === "seguir-comprando") {
              window.location.href = "index.html#productos";
            }

            if (target.id === "pedir-whatsapp") {
              document.getElementById("modal-pedido").style.display = "block";
            }

            if (target.classList.contains("cerrar-modal")) {
              document.getElementById("modal-pedido").style.display = "none";
            }
          });

          const form = document.getElementById("formulario-pedido");
          if (form) {
            form.addEventListener("submit", (e) => {
              e.preventDefault();
              this.procesarPedido();
            });
          }
        },
      };

      carrito.mostrarCarrito();
      carrito.setupEventListeners();
    });
  </script>
</body>
</html>